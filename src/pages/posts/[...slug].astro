---
import { type CollectionEntry, getCollection } from "astro:content";
import CodeCopyButton from "../../components/CodeCopyButton.astro";
import HeadingLinks from "../../components/HeadingLinks.astro";
import ImageViewer from "../../components/ImageViewer.astro";
import PostTable from "../../components/PostTable.astro";
import ScrollProgress from "../../components/ScrollProgress.astro";
import TableOfContents from "../../components/TableOfContents.astro";
import { SITE_TITLE } from "../../consts";
import Layout from "../../layouts/Layout.astro";
import { formatDate } from "../../lib/utils";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  // 过滤草稿并按日期降序排序（最新的在前）
  const publishedPosts = posts
    .filter((post) => !post.data.draft)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

  return publishedPosts.map((post, index) => ({
    params: { slug: post.slug },
    props: {
      post,
      // 列表顺序：新 -> 旧
      // 上一篇（较新）：index - 1
      // 下一篇（较旧）：index + 1
      prevPost:
        index + 1 < publishedPosts.length
          ? publishedPosts[index + 1]
          : undefined,
      nextPost: index > 0 ? publishedPosts[index - 1] : undefined,
    },
  }));
}

type Props = {
  post: CollectionEntry<"posts">;
  prevPost?: CollectionEntry<"posts">;
  nextPost?: CollectionEntry<"posts">;
};

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await post.render();

const pageTitle = `${post.data.title} - ${SITE_TITLE}`;
---

<Layout
  title={pageTitle}
  description={post.data.description}
  image={post.data.image}
  containerClass="max-w-7xl"
  className="!p-0"
  article={true}
>
  <main
    class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-center lg:gap-8"
  >
    <TableOfContents headings={headings} />
    <article
      class="w-full max-w-[210mm] flex-shrink-0 bg-white shadow-2xl dark:bg-zinc-900 lg:my-6"
      itemscope
      itemtype="https://schema.org/BlogPosting"
    >
      <div class="p-6">
        <header class="border-b border-zinc-200 pb-4 dark:border-zinc-700">
          <h1
            class="mb-2 text-xl font-semibold"
            itemprop="headline"
            transition:name={`title-${post.slug}`}
          >
            {post.data.title}
          </h1>
          <div
            class="flex flex-wrap items-center gap-x-3 gap-y-1 font-mono text-xs text-zinc-600 dark:text-zinc-400"
          >
            <time
              datetime={post.data.date.toISOString()}
              itemprop="datePublished"
            >
              {formatDate(post.data.date)}
            </time>
            {
              post.data.author && (
                <span
                  itemprop="author"
                  itemscope
                  itemtype="https://schema.org/Person"
                >
                  · <span itemprop="name">{post.data.author}</span>
                </span>
              )
            }
          </div>
          {
            post.data.tags && post.data.tags.length > 0 && (
              <div class="mt-3 flex flex-wrap gap-2">
                {post.data.tags.map((tag) => (
                  <a
                    href={`/tags/${tag}`}
                    class="rounded-full bg-blue-100 px-2 py-1 text-xs font-medium text-blue-700 transition-colors hover:bg-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:hover:bg-blue-900/50"
                  >
                    #{tag}
                  </a>
                ))}
              </div>
            )
          }
        </header>

        <div class="prose-custom mt-6" itemprop="articleBody">
          <Content components={{ table: PostTable }} />
        </div>

        <hr class="my-8 border-zinc-200 dark:border-zinc-800" />

        <nav class="flex flex-col justify-between gap-6 sm:flex-row">
          {
            prevPost ? (
              <a
                href={`/posts/${prevPost.slug}`}
                class="group flex w-full flex-col gap-1.5 text-left sm:w-1/2"
              >
                <span class="flex items-center gap-1 text-xs text-zinc-500 transition-colors group-hover:text-blue-600 dark:text-zinc-400 dark:group-hover:text-blue-400">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="m15 18-6-6 6-6" />
                  </svg>
                  上一篇
                </span>
                <span class="line-clamp-2 text-sm font-medium transition-colors group-hover:text-blue-600 dark:group-hover:text-blue-400">
                  {prevPost.data.title}
                </span>
              </a>
            ) : (
              <div class="w-full sm:w-1/2" />
            )
          }

          {
            nextPost ? (
              <a
                href={`/posts/${nextPost.slug}`}
                class="group flex w-full flex-col gap-1.5 text-right sm:w-1/2"
              >
                <span class="flex items-center justify-end gap-1 text-xs text-zinc-500 transition-colors group-hover:text-blue-600 dark:text-zinc-400 dark:group-hover:text-blue-400">
                  下一篇
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="m9 18 6-6-6-6" />
                  </svg>
                </span>
                <span class="line-clamp-2 text-sm font-medium transition-colors group-hover:text-blue-600 dark:group-hover:text-blue-400">
                  {nextPost.data.title}
                </span>
              </a>
            ) : (
              <div class="w-full sm:w-1/2" />
            )
          }
        </nav>
      </div>
    </article>
  </main>
  <CodeCopyButton />
  <ImageViewer />
  <ScrollProgress />
  <HeadingLinks />
</Layout>
